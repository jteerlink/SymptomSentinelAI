<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SymptomSentryAI Admin Tools</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #343a40;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        pre {
            background-color: #343a40;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }
        .system-status {
            background-color: #6c757d;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1>SymptomSentryAI Admin Tools</h1>
            <p class="mb-0">Advanced administrative tools for testing and system management</p>
        </div>
        
        <div class="system-status">
            <h5 class="mb-2">System Status</h5>
            <div class="row">
                <div class="col-md-4">
                    <strong>Backend:</strong> <span id="backend-status">Checking...</span>
                </div>
                <div class="col-md-4">
                    <strong>Database:</strong> <span id="db-status">Checking...</span>
                </div>
                <div class="col-md-4">
                    <strong>ML System:</strong> <span id="ml-status">Checking...</span>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- User Management -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        User Management
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button id="clear-all-users" class="btn btn-danger">Clear All Users</button>
                            <button id="check-user-count" class="btn btn-secondary ms-2">Check User Count</button>
                        </div>
                        
                        <hr>
                        
                        <h5>Create Test User</h5>
                        <form id="create-user-form">
                            <div class="mb-3">
                                <label for="user-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="user-email" value="test@example.com" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="user-password" class="form-label">Password</label>
                                        <input type="text" class="form-control" id="user-password" value="password123" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="user-name" class="form-label">Name</label>
                                        <input type="text" class="form-control" id="user-name" value="Test User" required>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Create Test User</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Authentication Management -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Authentication Management
                    </div>
                    <div class="card-body">
                        <h5>Reset Authentication</h5>
                        <p>Reset all authentication cookies and clear local storage data from the browser.</p>
                        <button id="reset-auth" class="btn btn-warning">Reset Auth System</button>
                        
                        <hr>
                        
                        <h5>Auth Modal Fix</h5>
                        <p>Fix issues with the authentication modal not displaying correctly.</p>
                        <button id="fix-auth-modal" class="btn btn-primary">Fix Auth Modal</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Command Output
                    </div>
                    <div class="card-body">
                        <pre id="output">Ready for commands...</pre>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <button id="return-to-app" class="btn btn-lg btn-primary">Return to Application</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const outputEl = document.getElementById('output');
            
            function log(message) {
                const timestamp = new Date().toLocaleTimeString();
                outputEl.innerHTML += `[${timestamp}] ${message}\n`;
                outputEl.scrollTop = outputEl.scrollHeight;
            }
            
            // Check system status
            async function checkSystemStatus() {
                const backendStatus = document.getElementById('backend-status');
                const dbStatus = document.getElementById('db-status');
                const mlStatus = document.getElementById('ml-status');
                
                try {
                    // Check backend status
                    const backendResponse = await fetch('/api/health');
                    if (backendResponse.ok) {
                        backendStatus.textContent = 'Online ✅';
                        backendStatus.style.color = '#28a745';
                    } else {
                        backendStatus.textContent = 'Issues ⚠️';
                        backendStatus.style.color = '#ffc107';
                    }
                    
                    // DB status is assumed from backend
                    const backendData = await backendResponse.json();
                    if (backendData.database === 'connected') {
                        dbStatus.textContent = 'Connected ✅';
                        dbStatus.style.color = '#28a745';
                    } else {
                        dbStatus.textContent = 'Issues ⚠️';
                        dbStatus.style.color = '#ffc107';
                    }
                    
                    // Check ML system status
                    const mlResponse = await fetch('/api/ml-status');
                    if (mlResponse.ok) {
                        mlStatus.textContent = 'Online ✅';
                        mlStatus.style.color = '#28a745';
                    } else {
                        mlStatus.textContent = 'Limited ⚠️';
                        mlStatus.style.color = '#ffc107';
                    }
                } catch (error) {
                    backendStatus.textContent = 'Offline ❌';
                    backendStatus.style.color = '#dc3545';
                    dbStatus.textContent = 'Unknown ❓';
                    dbStatus.style.color = '#6c757d';
                    mlStatus.textContent = 'Unknown ❓';
                    mlStatus.style.color = '#6c757d';
                    log(`Error checking system status: ${error.message}`);
                }
            }
            
            // Clear all users
            document.getElementById('clear-all-users').addEventListener('click', async function() {
                if (!confirm('⚠️ WARNING: This will delete ALL users from the database. Are you sure?')) {
                    return;
                }
                
                log('Clearing all users from the database...');
                
                try {
                    const response = await fetch('/api/admin/clear-all-users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    log(`Server response: ${JSON.stringify(data)}`);
                    
                    if (response.ok) {
                        log('✅ All users have been cleared from the database.');
                    } else {
                        log(`❌ Error: ${data.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    log(`❌ Error: ${error.message}`);
                }
            });
            
            // Check user count
            document.getElementById('check-user-count').addEventListener('click', async function() {
                log('Checking user count...');
                
                try {
                    const response = await fetch('/api/admin/user-count');
                    const data = await response.json();
                    
                    if (response.ok) {
                        log(`User count: ${data.count}`);
                    } else {
                        log(`❌ Error: ${data.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    log(`❌ Error: ${error.message}`);
                }
            });
            
            // Create test user
            document.getElementById('create-user-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('user-email').value;
                const password = document.getElementById('user-password').value;
                const fullName = document.getElementById('user-name').value;
                
                // Split name into first and last
                const nameParts = fullName.split(' ');
                const firstName = nameParts[0] || 'Test';
                const lastName = nameParts.slice(1).join(' ') || 'User';
                
                log(`Creating test user: ${email} / ${fullName}`);
                
                try {
                    const response = await fetch('/api/admin/create-test-user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email,
                            password,
                            firstName,
                            lastName
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        log(`✅ Test user created successfully! ID: ${data.userId}`);
                        log(`----- LOGIN CREDENTIALS -----`);
                        log(`Email: ${email}`);
                        log(`Password: ${password}`);
                        log(`----------------------------`);
                    } else {
                        log(`❌ Error: ${data.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    log(`❌ Error: ${error.message}`);
                }
            });
            
            // Reset auth system
            document.getElementById('reset-auth').addEventListener('click', function() {
                log('Resetting authentication system...');
                
                // Clear all localStorage items related to authentication
                localStorage.removeItem('authToken');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('tokenExpires');
                localStorage.removeItem('hasPerformedAnalysis');
                localStorage.removeItem('lastAnalysisId');
                localStorage.removeItem('lastAnalysisResults');
                localStorage.removeItem('userProfile');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                
                // Clear session storage completely
                sessionStorage.clear();
                
                // Clear cookies
                document.cookie = 'authToken=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;';
                document.cookie = 'refreshToken=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;';
                
                // Logout API call
                fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(response => {
                    log(`Logout API response: ${response.status}`);
                    log('✅ Authentication reset complete.');
                })
                .catch(error => {
                    log(`❌ Error during server logout: ${error.message}`);
                });
            });
            
            // Fix auth modal
            document.getElementById('fix-auth-modal').addEventListener('click', function() {
                log('Fixing authentication modal...');
                window.location.href = '/fix-auth-modal.html';
            });
            
            // Return to app
            document.getElementById('return-to-app').addEventListener('click', function() {
                window.location.href = '/';
            });
            
            // Initialize
            log('Admin tools initialized.');
            checkSystemStatus();
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>